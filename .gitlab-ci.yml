stages:
  - prepare
  - test
  - build
  - deploy

variables:
  TARGET_BRANCH: "CICD_2"
  # Docker configuration - disable TLS for simplicity
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375
  
  # Package Registry configuration
  IMAGE_NAME: "$CI_REGISTRY_IMAGE/team03-webapi"
  
  # Git configuration
  GIT_STRATEGY: none
  GIT_USERNAME: "fsa_HongTL"

# Default configuration for all jobs
default:
  image: mcr.microsoft.com/dotnet/sdk:8.0

prepare:
  stage: prepare
  image: mcr.microsoft.com/dotnet/sdk:8.0
  rules:
    - if: $CI_COMMIT_BRANCH == $TARGET_BRANCH
  script:
    - apt-get update && apt-get install -y git curl jq
    # Configure Git authentication with personal token
    - echo "Configuring Git credentials..."
    - git config --global credential.helper store
    - echo "https://${GIT_USERNAME}:${GIT_ACCESS_TOKEN}@git.fa.edu.vn" > ~/.git-credentials
    - git config --global user.name "$GIT_USERNAME"
    - git config --global user.email "$GIT_USERNAME@users.noreply.gitlab.com"
    - echo "Testing Git authentication..."
    - git ls-remote "http://git.fa.edu.vn/hcm25_cpl_net_06/team03_be.git" || echo "Authentication test failed, but continuing"
    - echo "Prepare stage completed successfully"
  tags:
    - cicd

build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0
  rules:
    - if: $CI_COMMIT_BRANCH == $TARGET_BRANCH
  before_script:
    - apt-get update && apt-get install -y git curl openssh-client tar gzip
    # Configure Git authentication
    - echo "Configuring Git authentication..."
    - git config --global credential.helper store
    - echo "https://${GIT_USERNAME}:${GIT_ACCESS_TOKEN}@git.fa.edu.vn" > ~/.git-credentials
    - git config --global user.name "$GIT_USERNAME"
    - git config --global user.email "$GIT_USERNAME@users.noreply.gitlab.com"
    
    # Clone the repository
    - echo "Cloning repository..."
    - git clone -b $TARGET_BRANCH "http://git.fa.edu.vn/hcm25_cpl_net_06/team03_be.git" project_source || exit 1
    
    # Setup SSH for server connection
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # Write SSH key with proper line breaks using printf
    - echo "Creating SSH key file with proper format..."
    - printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    # Debug SSH key content
    - echo "Debug - SSH key file first 3 lines:"
    - head -3 ~/.ssh/id_rsa
    - echo "Debug - SSH key file last 3 lines:"
    - tail -3 ~/.ssh/id_rsa
    - echo "Debug - SSH key line count:"
    - wc -l ~/.ssh/id_rsa
    # Verify SSH key format
    - head -1 ~/.ssh/id_rsa | grep -q "BEGIN" || (echo "SSH key format error - first line:" && head -1 ~/.ssh/id_rsa && exit 1)
    - tail -1 ~/.ssh/id_rsa | grep -q "END" || (echo "SSH key format error - last line:" && tail -1 ~/.ssh/id_rsa && exit 1)
    - eval $(ssh-agent -s)
    - ssh-add ~/.ssh/id_rsa || (echo "Failed to add SSH key" && exit 1)
    # Generate and show public key for comparison
    - echo "Generating public key from private key:"
    - ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub
    - echo "Public key content:"
    - cat ~/.ssh/id_rsa.pub
    - echo "SSH key fingerprint:"
    - ssh-keygen -lf ~/.ssh/id_rsa.pub
    - echo "Adding server to known_hosts..."
    - ssh-keyscan -H -T 10 vps.purintech.id.vn >> ~/.ssh/known_hosts || echo "Warning: ssh-keyscan failed, but continuing"
    - echo "Alternatively adding server to known_hosts with timeout..."
    - timeout 10 ssh-keyscan vps.purintech.id.vn >> ~/.ssh/known_hosts || echo "Host key scan failed, will use StrictHostKeyChecking=no"
  script:
    - echo "Transferring source code to server..."
    - cd project_source
    - tar -czf ../project.tar.gz .
    - cd ..
    - echo "Testing SSH connection..."
    - echo "First check if server is reachable..."
    - ping -c 3 vps.purintech.id.vn || echo "Ping failed, but trying SSH anyway"
    - echo "Debug SSH connection with verbose output:"
    - ssh -vvv -o ConnectTimeout=30 -o StrictHostKeyChecking=no fsoftguy@vps.purintech.id.vn "echo 'SSH connection successful'" || echo "SSH key auth failed - need to check server authorized_keys"
    - echo "Copying project file to server..."
    - scp -v -o ConnectTimeout=30 project.tar.gz fsoftguy@vps.purintech.id.vn:/tmp/ || (echo "SCP failed - ensure SSH public key is installed on server" && exit 1)
    
    - echo "Building Docker image on server..."
    - |
      ssh -o StrictHostKeyChecking=no fsoftguy@vps.purintech.id.vn "
        echo 'Extracting source code...'
        mkdir -p /tmp/team03_build
        cd /tmp/team03_build
        tar -xzf /tmp/project.tar.gz
        
        echo 'Login to GitLab Container Registry...'
        echo '$CI_JOB_TOKEN' | docker login '$CI_REGISTRY' --username gitlab-ci-token --password-stdin
        
        echo 'Building Docker image on server...'
        docker build -t '$IMAGE_NAME:latest' -t '$IMAGE_NAME:$CI_COMMIT_SHA' .
        
        echo 'Pushing to GitLab Container Registry...'
        docker push '$IMAGE_NAME:latest'
        docker push '$IMAGE_NAME:$CI_COMMIT_SHA'
        
        echo 'Cleaning up build files...'
        cd /tmp
        rm -rf team03_build project.tar.gz
      " || (echo "SSH command failed" && exit 1)
  tags:
    - cicd

deploy:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:8.0
  rules:
    - if: $CI_COMMIT_BRANCH == $TARGET_BRANCH
  before_script:
    - apt-get update && apt-get install -y openssh-client curl
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # Write SSH key with proper line breaks using printf
    - echo "Creating SSH key file with proper format..."
    - printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    # Debug SSH key content
    - echo "Debug - SSH key file first 3 lines:"
    - head -3 ~/.ssh/id_rsa
    - echo "Debug - SSH key file last 3 lines:"
    - tail -3 ~/.ssh/id_rsa
    - echo "Debug - SSH key line count:"
    - wc -l ~/.ssh/id_rsa
    # Verify SSH key format
    - head -1 ~/.ssh/id_rsa | grep -q "BEGIN" || (echo "SSH key format error - first line:" && head -1 ~/.ssh/id_rsa && exit 1)
    - tail -1 ~/.ssh/id_rsa | grep -q "END" || (echo "SSH key format error - last line:" && tail -1 ~/.ssh/id_rsa && exit 1)
    - eval $(ssh-agent -s)
    - ssh-add ~/.ssh/id_rsa || (echo "Failed to add SSH key" && exit 1)
    - echo "Adding server to known_hosts..."
    - ssh-keyscan -H -T 10 vps.purintech.id.vn >> ~/.ssh/known_hosts || echo "Warning: ssh-keyscan failed, but continuing"
    - echo "Alternatively adding server to known_hosts with timeout..."
    - timeout 10 ssh-keyscan vps.purintech.id.vn >> ~/.ssh/known_hosts || echo "Host key scan failed, will use StrictHostKeyChecking=no"
  script:
    - echo "Deploying application on server..."
    - echo "Testing SSH connection for deploy..."
    - ssh -o StrictHostKeyChecking=no fsoftguy@vps.purintech.id.vn "echo 'SSH connection successful for deploy'"
    - |
      ssh -o StrictHostKeyChecking=no fsoftguy@vps.purintech.id.vn "
        echo 'Stopping and removing old container...'
        docker stop team03-webapi || true
        docker rm team03-webapi || true
        
        echo 'Starting new container with latest image...'
        docker run -d --name team03-webapi -p 8080:80 --restart unless-stopped '$IMAGE_NAME:latest'
        
        echo 'Checking deployment status...'
        docker ps | grep team03-webapi
        
        echo 'Testing application endpoint...'
        sleep 5
        curl -f http://localhost:8080/health || echo 'Health check endpoint not available, but container is running'
      " || (echo "Deploy SSH command failed" && exit 1)
  tags:
    - cicd
