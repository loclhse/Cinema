stages:
  - build
  - test
  - docker
  - deploy_dev
  - deploy_prod

.default-dotnet-template: &dotnet-template
  image: mcr.microsoft.com/dotnet/sdk:7.0
  tags:
    - deploy
  before_script:
    - export PATH="$PATH:/root/.dotnet/tools"
    - dotnet tool install --global dotnet-ef || true
    - dotnet restore

build:
  <<: *dotnet-template
  stage: build
  script:
    - dotnet build --no-restore

test:
  <<: *dotnet-template
  stage: test
  script:
    - dotnet test --no-restore --no-build

docker_build:
  image: docker:latest
  stage: docker
  tags:
    - deploy
  services:
    - docker:dind
  script:
    - docker build -t team03_be .
    - docker tag team03_be registry.gitlab.com/hcm25_cpl_net_06/team03_be:latest
    - echo "$CI_JOB_TOKEN" | docker login -u gitlab-ci-token --password-stdin registry.gitlab.com
    - docker push registry.gitlab.com/hcm25_cpl_net_06/team03_be:latest

deploy_dev:
  stage: deploy_dev
  tags:
    - deploy
  script:
    - echo "Deploying to deelopment srver..."

deploy_prod:
  stage: deploy_prod
  tags:
    - deploy
  script:
    - echo "Deploying to production server..."
