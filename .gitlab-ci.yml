stages:
  - prepare
  - test
  - build

variables:
  TARGET_BRANCH: "CICD_2"
  IMAGE_NAME: "git.fa.edu.vn/hcm25_cpl_net_06/team03_be/team03-webapi"
  GIT_STRATEGY: none
  GIT_USERNAME: "fsa_HongTL"

default:
  image: mcr.microsoft.com/dotnet/sdk:8.0

prepare:
  stage: prepare
  image: mcr.microsoft.com/dotnet/sdk:8.0
  rules:
    - if: $CI_COMMIT_BRANCH == $TARGET_BRANCH
  script:
    - apt-get update && apt-get install -y git curl jq
    - echo "Configuring Git credentials..."
    - git config --global credential.helper store
    - echo "https://${GIT_USERNAME}:${GIT_ACCESS_TOKEN}@git.fa.edu.vn" > ~/.git-credentials
    - git config --global user.name "$GIT_USERNAME"
    - git config --global user.email "$GIT_USERNAME@users.noreply.gitlab.com"
    - echo "Testing Git authentication..."
    - git ls-remote "http://git.fa.edu.vn/hcm25_cpl_net_06/team03_be.git" || echo "Authentication test failed, but continuing"
    - echo "Prepare stage completed successfully"
  tags:
    - cicd

build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0
  rules:
    - if: $CI_COMMIT_BRANCH == $TARGET_BRANCH
  before_script:
    - apt-get update && apt-get install -y openssh-client curl tar gzip git
    - echo "Configuring Git authentication..."
    - git config --global credential.helper store
    - echo "https://${GIT_USERNAME}:${GIT_ACCESS_TOKEN}@git.fa.edu.vn" > ~/.git-credentials
    - git config --global user.name "$GIT_USERNAME"
    - git config --global user.email "$GIT_USERNAME@users.noreply.gitlab.com"
    - echo "Cloning repository..."
    - git clone -b $TARGET_BRANCH "http://git.fa.edu.vn/hcm25_cpl_net_06/team03_be.git" project_source || exit 1
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - eval $(ssh-agent -s)
    - ssh-add ~/.ssh/id_rsa
    - ssh-keyscan -H vps.purintech.id.vn >> ~/.ssh/known_hosts 2>/dev/null || echo "SSH keyscan failed"
  script:
    - echo "Transferring source code to server for Docker build..."
    - echo "Preparing source code archive..."
    - cd project_source
    - tar -czf ../project.tar.gz .
    - cd ..
    - echo "Uploading source code to server..."
    - scp -o StrictHostKeyChecking=no project.tar.gz fsoftguy@vps.purintech.id.vn:~/project.tar.gz
    - |
      timeout 600 ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=60 fsoftguy@vps.purintech.id.vn "
        set -e
        echo 'Creating build directory...'
        BUILD_DIR=~/docker-builds/team03-build-\$(date +%Y%m%d-%H%M%S)
        mkdir -p \$BUILD_DIR
        echo \"Build directory: \$BUILD_DIR\"
        
        echo 'Moving source code to build directory...'
        cd \$BUILD_DIR
        mv ~/project.tar.gz .
        tar -xzf project.tar.gz
        rm project.tar.gz
        
        echo 'Setting up Docker environment...'
        export PATH=\"\$HOME/bin:\$PATH\"
        export DOCKER_HOST=\"unix:///run/user/\$(id -u)/docker.sock\"
        
        systemctl --user start docker.service 2>/dev/null || echo 'Docker service already running'
        sleep 3
        
        echo 'Testing Docker access...'
        if docker version > /dev/null 2>&1; then
          echo 'Rootless Docker accessible!'
          echo \"Docker version: \$(docker version --format '{{.Server.Version}}')\"
        else
          echo 'Docker not accessible!'
          echo 'Checking Docker service status:'
          systemctl --user status docker.service
          exit 1
        fi
        
        echo 'Checking Dockerfile...'
        if [ ! -f Dockerfile ]; then
          echo 'ERROR: Dockerfile not found!'
          ls -la
          exit 1
        fi
        
        echo 'Logging into GitLab Container Registry...'
        echo 'Skipping registry login - using local images only'
        
        echo 'Building Docker image...'
        docker build -t 'team03-webapi:latest' -t 'team03-webapi:$CI_COMMIT_SHA' .
        
        if [ \$? -eq 0 ]; then
          echo 'Docker build successful!'
          echo 'BUILD_STATUS=SUCCESS' > ~/build_status.txt
          
          echo 'Deploying immediately...'
          echo 'Simple but effective cleanup...'
          
          # Step 1: Stop and remove containers by name
          echo 'Stopping containers by name...'
          docker stop team03-webapi 2>/dev/null || echo 'Container not running'
          docker rm -f team03-webapi 2>/dev/null || echo 'Container not found'
          
          # Step 2: Clean up any remaining containers on port 8080
          echo 'Finding containers on port 8080...'
          CONTAINERS_ON_8080=\$(docker ps --format '{{.ID}} {{.Ports}}' | grep '8080' | awk '{print \$1}' || echo '')
          if [ -n \"\$CONTAINERS_ON_8080\" ]; then
            echo \"Found containers on port 8080: \$CONTAINERS_ON_8080\"
            echo \$CONTAINERS_ON_8080 | xargs -r docker stop 2>/dev/null || echo 'Stop failed'
            echo \$CONTAINERS_ON_8080 | xargs -r docker rm -f 2>/dev/null || echo 'Remove failed'
          else
            echo 'No containers found on port 8080'
          fi
          
          # Step 3: Quick port check
          sleep 2
          echo 'Port 8080 status:'
          netstat -ln | grep ':8080' || echo 'Port 8080 is free'
          
          echo 'Starting new container...'
          CONTAINER_ID=\$(docker run -d \\
            --name team03-webapi \\
            -p 8080:8080 \\
            --restart unless-stopped \\
            team03-webapi:latest 2>&1)
          
          if echo \"\$CONTAINER_ID\" | grep -q '^[a-f0-9]\\{12\\}'; then
            echo \"Container started successfully: \$CONTAINER_ID\"
            
            echo 'Verifying deployment...'
            sleep 5
            if docker ps | grep team03-webapi > /dev/null; then
              echo 'Container is running successfully!'
              docker ps --format 'table {{.Names}}\\t{{.Status}}\\t{{.Ports}}' | grep team03-webapi
              
              echo 'Checking application health...'
              sleep 10
              curl -f http://localhost:8080 > /dev/null 2>&1 && echo 'Application is responding!' || echo 'Application endpoint not available yet'
              
              echo ''
              echo '===== DEPLOYMENT SUCCESSFUL ====='
              echo 'Application URL: http://vps.purintech.id.vn:8080'
              echo 'API Base URL: http://vps.purintech.id.vn:8080/api'
              echo 'Swagger UI: http://vps.purintech.id.vn:8080/swagger'
              echo 'Health Check: http://vps.purintech.id.vn:8080/health'
              echo '=================================='
              echo 'Your application is now live and accessible!'
              echo 'BUILD_STATUS=SUCCESS' > ~/build_status.txt
            else
              echo 'Container failed to start properly!'
              echo 'Container logs:'
              docker logs team03-webapi 2>/dev/null | tail -20 || echo 'No logs available'
              echo 'BUILD_STATUS=DEPLOY_FAILED' > ~/build_status.txt
            fi
          else
            echo \"Failed to start container. Error: \$CONTAINER_ID\"
            echo 'BUILD_STATUS=DEPLOY_FAILED' > ~/build_status.txt
          fi
        else
          echo 'Docker build failed!'
          echo 'BUILD_STATUS=BUILD_FAILED' > ~/build_status.txt
        fi
        
        echo 'Cleaning up build directory...'
        cd ~
        rm -rf \$BUILD_DIR
        
        echo 'Build process completed!'
      "
    - ssh -o StrictHostKeyChecking=no fsoftguy@vps.purintech.id.vn "cat ~/build_status.txt 2>/dev/null || echo 'BUILD_STATUS=UNKNOWN'" > build_status.txt
    - cat build_status.txt
  artifacts:
    reports:
      dotenv: build_status.txt
    expire_in: 1 hour
  tags:
    - cicd
