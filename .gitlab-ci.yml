# GitLab CI/CD Pipeline for .NET Core Web API
# Compatible with runner #411 (tags: deploy, docker)

variables:
  DOTNET_VERSION: "8.0"
  SOLUTION_PATH: "WebAPI/WebAPI.sln"
  PROJECT_PATH: "WebAPI/WebAPI/WebAPI.csproj"
  TEST_PATH: "WebAPI/ZTest/ZTest.csproj"
  DOCKER_IMAGE_NAME: "team03-webapi"
  TARGET_BRANCH: "CICD_2"
  GIT_USERNAME: "fsa_HongTL"
  GIT_STRATEGY: none

# Default configuration for all jobs
default:
  image: mcr.microsoft.com/dotnet/sdk:8.0

stages:
  # - test
  - docker
  - test-docker
  # - deploy

# # Run unit tests
# unit-tests:
#   stage: test
#   tags:
#     - cicd
#   before_script:
#     - echo "=== Debug Git Authentication ==="
#     - 'if [ -z "${GIT_ACCESS_TOKEN}" ]; then echo "ERROR: GIT_ACCESS_TOKEN is empty!"; exit 1; else echo "GIT_ACCESS_TOKEN is set"; fi'
#     - echo "Configuring Git authentication..."
#     - git config --global url."https://${GIT_USERNAME}:${GIT_ACCESS_TOKEN}@git.fa.edu.vn/".insteadOf "https://git.fa.edu.vn/"
#     - echo "Git authentication configured successfully"
#     - echo "=== Cloning repository manually after authentication ==="
#     - git clone https://git.fa.edu.vn/hcm25_cpl_net_06/team03_be.git .
#     - git checkout ${CI_COMMIT_SHA}
#     - echo "Repository cloned successfully"
#   script:
#     - echo "=== Running Unit Tests ==="
#     - echo "Current directory:"
#     - pwd
#     - echo "Available files and directories:"
#     - ls -la
#     - echo "Checking if WebAPI directory exists:"
#     - if [ -d "WebAPI" ]; then echo "WebAPI directory found"; else echo "WebAPI directory NOT found"; fi
#     - cd WebAPI
#     - echo "WebAPI directory contents:"
#     - ls -la
#     - echo "Restoring packages..."
#     - dotnet restore WebAPI.sln
#     - echo "Building solution..."
#     - dotnet build WebAPI.sln --configuration Release
#     - echo "Running tests with coverage..."
#     - mkdir -p TestResults
#     - dotnet test ZTest/ZTest.csproj --configuration Release --no-build --logger trx --results-directory TestResults/
#     - echo "=== Tests completed! ==="
#   artifacts:
#     when: always
#     paths:
#       - WebAPI/TestResults/
#     reports:
#       junit:
#         - WebAPI/TestResults/*.trx
#     expire_in: 1 week
#   rules:
#     - if: '$CI_COMMIT_REF_NAME == $TARGET_BRANCH'

# # Code quality check
# code-quality:
#   stage: test
#   tags:
#     - cicd
#   before_script:
#     - echo "=== Debug Git Authentication ==="
#     - 'if [ -z "${GIT_ACCESS_TOKEN}" ]; then echo "ERROR: GIT_ACCESS_TOKEN is empty!"; exit 1; else echo "GIT_ACCESS_TOKEN is set"; fi'
#     - echo "Configuring Git authentication..."
#     - git config --global url."https://${GIT_USERNAME}:${GIT_ACCESS_TOKEN}@git.fa.edu.vn/".insteadOf "https://git.fa.edu.vn/"
#     - git config --global url."https://${GIT_USERNAME}:${GIT_ACCESS_TOKEN}@git.fa.edu.vn/".insteadOf "http://git.fa.edu.vn/"
#     - echo "Git authentication configured successfully"
#     - echo "=== Cloning repository manually after authentication ==="
#     - git clone https://git.fa.edu.vn/hcm25_cpl_net_06/team03_be.git .
#     - git checkout ${CI_COMMIT_SHA}
#     - echo "Repository cloned successfully"
#   script:
#     - echo "=== Code Quality Analysis ==="
#     - echo "Current directory:"
#     - pwd
#     - echo "Available files:"
#     - ls -la
#     - cd WebAPI
#     - echo "WebAPI directory contents:"
#     - ls -la
#     - echo "Restoring packages..."
#     - dotnet restore WebAPI.sln
#     - echo "Building solution..."
#     - dotnet build WebAPI.sln --configuration Release
#     - echo "Checking code format..."
#     - dotnet format --verify-no-changes --verbosity diagnostic WebAPI.sln || echo "⚠️ Code formatting issues found"
#     - echo "=== Code quality check completed! ==="
#   allow_failure: true
#   rules:
#     - if: '$CI_COMMIT_REF_NAME == $TARGET_BRANCH'

# Build Docker image using Kaniko
docker-build:
  stage: docker
  tags:
    - cicd
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
  before_script:
    - echo "=== Kaniko Docker Build Setup ==="
    - echo "Installing git for authentication..."
    - apk add --no-cache git
    - echo "=== Git Authentication for Docker Build ==="
    - 'if [ -z "${GIT_ACCESS_TOKEN}" ]; then echo "ERROR: GIT_ACCESS_TOKEN is empty!"; exit 1; else echo "GIT_ACCESS_TOKEN is set"; fi'
    - echo "Configuring Git authentication..."
    - git config --global url."https://${GIT_USERNAME}:${GIT_ACCESS_TOKEN}@git.fa.edu.vn/".insteadOf "https://git.fa.edu.vn/"
    - echo "Git authentication configured successfully"
    - echo "=== Cloning repository for Docker build ==="
    - git clone https://git.fa.edu.vn/hcm25_cpl_net_06/team03_be.git .
    - git checkout ${CI_COMMIT_SHA}
    - echo "Repository cloned successfully"
    - echo "=== Verifying project structure ==="
    - ls -la
    - echo "WebAPI directory contents:"
    - ls -la WebAPI/
    - echo "Checking Dockerfile..."
    - if [ -f "Dockerfile" ]; then echo "✅ Dockerfile found"; else echo "❌ Dockerfile NOT found"; exit 1; fi
    - echo "Checking WebAPI.csproj..."
    - if [ -f "WebAPI/WebAPI/WebAPI.csproj" ]; then echo "✅ WebAPI.csproj found"; else echo "❌ WebAPI.csproj NOT found"; exit 1; fi
    - echo "=== Kaniko setup ==="
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
  script:
    - echo "=== Building Docker Image with Kaniko ==="
    - echo "Build context:"
    - pwd
    - echo "Building and pushing images..."
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}/${DOCKER_IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}"
      --destination "${CI_REGISTRY_IMAGE}/${DOCKER_IMAGE_NAME}:latest"
      --cache=true
      --cache-ttl=24h
    - echo "=== Kaniko build and push completed successfully! ==="
    - echo "Image tags pushed:"
    - echo "  - $CI_REGISTRY_IMAGE/$DOCKER_IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
    - echo "  - $CI_REGISTRY_IMAGE/$DOCKER_IMAGE_NAME:latest"
  rules:
    - if: '$CI_COMMIT_REF_NAME == $TARGET_BRANCH'

# Verify Docker image in registry
verify-docker-image:
  stage: test-docker
  tags:
    - cicd
  image: curlimages/curl:latest
  dependencies:
    - docker-build
  before_script:
    - echo "=== Docker Image Verification Setup ==="
  script:
    - echo "=== Verifying Docker Image in Registry ==="
    - echo "Checking if image exists in GitLab Container Registry..."
    - echo "Registry URL: $CI_REGISTRY_IMAGE/$DOCKER_IMAGE_NAME"
    - echo "Commit SHA tag: $CI_COMMIT_SHORT_SHA"
    - echo "Latest tag verification"
    - echo "Image should be available at:"
    - echo "  - $CI_REGISTRY_IMAGE/$DOCKER_IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
    - echo "  - $CI_REGISTRY_IMAGE/$DOCKER_IMAGE_NAME:latest"
    - echo "=== Docker image verification completed ==="
    - echo "✅ Image built and pushed successfully with Kaniko"
  rules:
    - if: '$CI_COMMIT_REF_NAME == $TARGET_BRANCH'

# # Deploy to staging
# deploy-staging:
#   stage: deploy
#   tags:
#     - cicd
#   dependencies:
#     - docker-build
#   environment:
#     name: staging
#     url: http://staging.team03-api.local
#   script:
#     - echo "=== Deploying to Staging ==="
#     - echo "Stopping existing containers..."
#     - docker-compose -f docker-compose.yml down || true
#     - echo "Pulling latest images..."
#     - docker-compose -f docker-compose.yml pull
#     - echo "Starting new containers..."
#     - docker-compose -f docker-compose.yml up -d
#     - echo "Waiting for application to start..."
#     - sleep 30
#     - echo "=== Deployment to staging completed! ==="
#   rules:
#     - if: '$CI_COMMIT_REF_NAME == $TARGET_BRANCH'

# # Deploy to production (manual)
# deploy-production:
#   stage: deploy
#   tags:
#     - cicd
#   dependencies:
#     - docker-build
#   environment:
#     name: production
#     url: http://team03-api.production.local
#   script:
#     - echo "=== Deploying to Production ==="
#     - echo "Stopping existing containers..."
#     - docker-compose -f docker-compose.yml down || true
#     - echo "Pulling latest images..."
#     - docker-compose -f docker-compose.yml pull
#     - echo "Starting new containers..."
#     - docker-compose -f docker-compose.yml up -d
#     - echo "Waiting for application to start..."
#     - sleep 30
#     - echo "=== Deployment to production completed! ==="
#   when: manual
#   rules:
#     - if: '$CI_COMMIT_REF_NAME == $TARGET_BRANCH'
